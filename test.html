<html lang="en"><head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Space shooter</title>
  <style>* {
  image-rendering: pixelated;
}

#game {
  background-color: black;
  width: 640px;
  height: 480px;
}

img {
  display: none;
}</style>
  <script>import AnimatedAction from "../lib/AnimatedAction.js";
import Bullet from "./Bullet.js";
import EvilShip from "./EvilShip.js";

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 320;
canvas.height = 240;

ctx.imageSmoothingEnabled       = false;
ctx.webkitImageSmoothingEnabled = false;
ctx.mozImageSmoothingEnabled    = false;
ctx.msImageSmoothingEnabled     = false;
ctx.oImageSmoothingEnabled      = false;


let entities = []
let spritesheet = document.getElementById("spritesheet");

let player = {
  x: canvas.width/2-32,
  y: canvas.height-100, 
  w: 32, 
  h: 32,
  speed: 0,
  moving: false,
  movingAnimation: new AnimatedAction(40, 4, spritesheet, 0, 8, 8, 8), 

  tick() {
      this.x += this.speed;

      if (this.x < 0 - (this.w/2)) {
          this.x = canvas.width;
      } 
      if (this.x > canvas.width + (this.w/2)) {
          this.x = 0;
      }
  },
  draw() {
      ctx.fillStyle = "red";
      // ctx.fillRect(this.x, this.y, this.w, this.h);

      if (this.moving) {
          this.movingAnimation.executeInfinite(ctx, this.x, this.y, this.w, this.h);
      } else {
          ctx.drawImage(spritesheet, 0, 8, 8, 8, this.x, this.y, this.w, this.h);
      }
      
  }
}

entities.push(player);

entities.push(new EvilShip(canvas, ctx, Math.floor(Math.random() * canvas.width), 32, 24, 24, 0, spritesheet, entities));
entities.push(new EvilShip(canvas, ctx, Math.floor(Math.random() * canvas.width), 32, 24, 24, 0, spritesheet, entities));
entities.push(new EvilShip(canvas, ctx, Math.floor(Math.random() * canvas.width), 32, 24, 24, 0, spritesheet, entities));
entities.push(new EvilShip(canvas, ctx, Math.floor(Math.random() * canvas.width), 32, 24, 24, 0, spritesheet, entities));
entities.push(new EvilShip(canvas, ctx, Math.floor(Math.random() * canvas.width), 32, 24, 24, 0, spritesheet, entities));

function clearScreen() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function gameLoop() {
  clearScreen();

  for (let i = 0; i < entities.length; i++) {
      let entity = entities[i];
      entity.tick();
      entity.draw();
  }

  window.requestAnimationFrame(gameLoop);
}

document.addEventListener('keydown', (event) => {
  var name = event.key;
  var code = event.code;
  if (code === "ArrowLeft") {
      player.speed = -4;
      player.moving = true;
  } else if (code === "ArrowRight") {
      player.speed = 4;
      player.moving = true;
  }
}, false);

document.addEventListener('keyup', (event) => {
  var name = event.key;
  var code = event.code;
  if (code === "ArrowLeft") {
      player.speed = 0;
      player.moving = false;
  } else if (code === "ArrowRight") {
      player.speed = 0;
      player.moving = false;
  }

  if (code === "Space") {
      entities.push(new Bullet(canvas, ctx, player.x+(player.w/2-12), player.y, 24, 24, 2, spritesheet, entities));
  }

}, false);

gameLoop();</script>
<base href="https://github.com/otthe/html5-simple-animation-handler/raw/master/src/example/"></head>
<body>
  <canvas id="game"></canvas>

  <img src="https://github.com/otthe/html5-simple-animation-handler/raw/master/src/example/res/spritesheet.png" id="spritesheet" alt="">

</body></html>